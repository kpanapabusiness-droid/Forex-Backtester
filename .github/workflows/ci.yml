name: CI
on:
  pull_request:
  push:
  workflow_dispatch:
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Diagnostics (early)
        id: diag
        shell: bash
        run: |
          set +e
          : > diag.log
          {
            echo "Runner: $RUNNER_OS"
            echo "Event: ${GITHUB_EVENT_NAME}"
            uname -a || true
            which python || true
            which python3 || true
            python --version || true
            python3 --version || true
            which pip || true
            pip --version || true
          } 2>&1 | tee -a diag.log

      - name: Setup Python
        id: setup
        uses: actions/setup-python@v5
        continue-on-error: true
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install
        id: install
        shell: bash
        run: |
          set -e
          python -m pip install -U pip
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Ruff
        id: ruff
        shell: bash
        run: |
          set +e
          set -o pipefail
          : > ruff.log
          ruff check . 2>&1 | tee -a ruff.log
          echo "RUFF_EXIT=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Pytest (full suite, clean env)
        id: pytest
        env:
          PYTEST_DISABLE_PLUGIN_AUTOLOAD: "1"
          PYTHONPATH: ${{ github.workspace }}
        shell: bash
        run: |
          set +e
          set -o pipefail
          : > pytest.log
          python -m pytest -q -c /dev/null 2>&1 | tee -a pytest.log
          echo "PYTEST_EXIT=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Smoke
        id: smoke
        shell: bash
        run: |
          set +e
          set -o pipefail
          : > smoke.log
          if [ -f smoke_test_full_v198.py ]; then python smoke_test_full_v198.py 2>&1 | tee -a smoke.log; fi
          echo "SMOKE_EXIT=${PIPESTATUS[0]:-0}" >> "$GITHUB_OUTPUT"

      - name: Fail at end if needed (gate on ruff+pytest+smoke)
        if: always()
        shell: bash
        run: |
          r="${{ steps.ruff.outputs.RUFF_EXIT }}"
          p="${{ steps.pytest.outputs.PYTEST_EXIT }}"
          s="${{ steps.smoke.outputs.SMOKE_EXIT }}"
          if [ "${r:-0}" != "0" ] || [ "${p:-0}" != "0" ] || [ "${s:-0}" != "0" ]; then exit 1; fi

      - name: Debug Discord Secret
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        shell: bash
        run: |
          if [ -z "${DISCORD_WEBHOOK_URL}" ]; then
            echo "❌ Secret not set"
            exit 1
          fi
          echo "✅ Secret length: ${#DISCORD_WEBHOOK_URL}"
          case "${DISCORD_WEBHOOK_URL}" in
            https://discord.com/api/webhooks/*) echo "✅ Secret looks like a Discord webhook URL" ;;
            *) echo "⚠️ Secret does not match expected format" ;;
          esac

      - name: Notify Discord on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        shell: bash
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          sp="${{ steps.setup.outcome }}"
          r="${{ steps.ruff.outputs.RUFF_EXIT }}"
          p="${{ steps.pytest.outputs.PYTEST_EXIT }}"
          s="${{ steps.smoke.outputs.SMOKE_EXIT }}"

          diag_tail="$(tail -n 40 diag.log 2>/dev/null || echo 'diag.log missing')"
          py_tail="$(tail -n 140 pytest.log 2>/dev/null || echo 'pytest.log missing')"
          rf_tail="$(tail -n 80 ruff.log 2>/dev/null || echo 'ruff.log missing')"
          sm_tail="$(tail -n 80 smoke.log 2>/dev/null || echo 'smoke.log missing')"

          export RUN_URL sp r p s diag_tail py_tail rf_tail sm_tail
          python - <<'PY'
          import os, json, urllib.request
          repo=os.environ.get('GITHUB_REPOSITORY','')
          ref=os.environ.get('GITHUB_REF_NAME','')
          run=os.environ.get('RUN_URL','')
          sp=os.environ.get('sp','')
          r=os.environ.get('r','')
          p=os.environ.get('p','')
          s=os.environ.get('s','')
          diag=os.environ.get('diag_tail','')
          py=os.environ.get('py_tail','')
          rf=os.environ.get('rf_tail','')
          sm=os.environ.get('sm_tail','')
          body=(f"**CI failed**: {repo} • {ref}\n{run}\n\n"
                f"setup={sp} • exits: ruff={r} pytest={p} smoke={s}\n\n"
                f"Pytest:\n```\n{py}\n```\n\n"
                f"Ruff:\n```\n{rf}\n```\n\n"
                f"Diagnostics:\n```\n{diag}\n```\n\n"
                f"Smoke:\n```\n{sm}\n```")
          data=json.dumps({"content": body}).encode()
          req=urllib.request.Request(os.environ['DISCORD_WEBHOOK_URL'], data=data, headers={'Content-Type':'application/json'})
          with urllib.request.urlopen(req) as resp:
              print(resp.status)
          PY
