name: CI
on:
  pull_request:
  push:
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install base test deps
        shell: bash
        run: |
          python -m pip install -U pip
          pip install -U pytest ruff
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Ruff
        id: ruff
        shell: bash
        run: |
          set +e
          set -o pipefail
          echo '--- RUFF START ---' > ruff.log
          ruff check . 2>&1 | tee -a ruff.log
          code=${PIPESTATUS[0]}
          echo "RUFF_EXIT=$code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Pytest
        id: pytest
        shell: bash
        run: |
          set +e
          set -o pipefail
          echo '--- PYTEST START ---' > pytest.log
          pytest -q 2>&1 | tee -a pytest.log
          code=${PIPESTATUS[0]}
          echo "PYTEST_EXIT=$code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Smoke test
        id: smoke
        shell: bash
        run: |
          set +e
          set -o pipefail
          echo '--- SMOKE START ---' > smoke.log
          python smoke_test_full_v198.py -q 2>&1 | tee -a smoke.log
          code=${PIPESTATUS[0]}
          echo "SMOKE_EXIT=$code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Mark job failed if any step failed
        if: always()
        shell: bash
        run: |
          r="${{ steps.ruff.outputs.RUFF_EXIT }}"
          p="${{ steps.pytest.outputs.PYTEST_EXIT }}"
          s="${{ steps.smoke.outputs.SMOKE_EXIT }}"
          echo "Recorded exits: ruff=$r pytest=$p smoke=$s"
          if [ "$r" != "0" ] || [ "$p" != "0" ] || [ "$s" != "0" ]; then
            exit 1
          fi

      - name: Ensure jq is available
        if: failure()
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Post to Discord on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        shell: bash
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          r="${{ steps.ruff.outputs.RUFF_EXIT }}"; p="${{ steps.pytest.outputs.PYTEST_EXIT }}"; s="${{ steps.smoke.outputs.SMOKE_EXIT }}"

          py_tail="$(if [ -s pytest.log ]; then tail -n 150 pytest.log; else echo 'pytest.log is empty'; fi)"
          sm_tail="$(if [ -s smoke.log ]; then tail -n 120 smoke.log; else echo 'smoke.log is empty'; fi)"
          rf_tail="$(if [ -s ruff.log ]; then tail -n 80 ruff.log; else echo 'ruff.log is empty'; fi)"

          py_tail="$(printf "%s" "$py_tail" | sed 's/`/\\`/g')"
          sm_tail="$(printf "%s" "$sm_tail" | sed 's/`/\\`/g')"
          rf_tail="$(printf "%s" "$rf_tail" | sed 's/`/\\`/g')"

          BODY="**CI failed**: ${{ github.repository }} â€¢ ${{ github.ref_name }}\n<$RUN_URL>\n\nExits: ruff=$r pytest=$p smoke=$s\n\nPytest:\n\`\`\`\n$py_tail\n\`\`\`\n\nSmoke:\n\`\`\`\n$sm_tail\n\`\`\`\n\nRuff:\n\`\`\`\n$rf_tail\n\`\`\`"
          BODY="$(printf "%s" "$BODY" | head -c 1900)"

          echo "$BODY" | jq -Rs '{content: .}' > payload.json
          curl -fsS -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK_URL"
